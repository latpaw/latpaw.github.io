<!DOCTYPE html>
<html lang="en-us">
<head>
  <title>Diary 2015-5 - L</title>
  <meta charset="utf-8" />
  <meta name="author" content="latpaw" />
  <meta name="description" content="&lt;TODO: insert your description here&gt;" />
  <meta name="keywords" content="&lt;TODO: insert your keywords here&gt;" />

  <link rel="alternate" title="RSS Feed" href="/rss.xml" type="application/rss+xml">
  <link rel="stylesheet" href="/media/css/main.css" type="text/css">
  <link rel="stylesheet" href="/media/css/posts.css" type="text/css">
</head>

  <body class="container">
<header id="header">
<body>
    <nav class="navbar navbar-default navbar-fixed-top" style="opacity: .9" role="navigation">
        <div class="container-fluid">
<div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">L</a>
        </div>
<div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav navbar-right">
                <li class="active"><a href="/blog/">Blog</a></li>
          <li><a href="/about/">About</a></li>
          <li><a href="/tags/">Tags</a></li>
          <li><a href="https://github.com/latpaw">GitHub</a></li>
        </ul>
</div>
</div>
    </nav>
</body>
</header>

<section id="content" role="main">
    <div id="outline-container-sec-" class="row" style="padding-top: 70px">
        <div class="col-md-2"></div>
            <h1>Diary 2015-5</h1>
            <div id="outline-container-org558ae2a" class="outline-2">
<h2 id="org558ae2a">diary 2015 05</h2>
<div class="outline-text-2" id="text-org558ae2a">
</div><div id="outline-container-org11c1a63" class="outline-3">
<h3 id="org11c1a63">2015-05-18</h3>
<div class="outline-text-3" id="text-org11c1a63">
</div><div id="outline-container-orge6c8aa0" class="outline-4">
<h4 id="orge6c8aa0">mysql 替换成 percona mysql</h4>
<div class="outline-text-4" id="text-orge6c8aa0">
<p>
需要先删除旧版的 oracle mysql
apt-get remove mysql-server mysql-common mysql-client
</p>

<p>
apt-key adv --keyserver keys.gnupg.net --recv-keys 1C4CBDCDCD2EFD2A
在/etc/apt/source.list 添加
deb <a href="http://repo.percona.com/apt">http://repo.percona.com/apt</a> VERSION main
deb-src <a href="http://repo.percona.com/apt">http://repo.percona.com/apt</a> VERSION main
</p>

<p>
apt-get update
apt-get install percona-server-server-5.6 percona-server-common percona-server-client-5.6
</p>

<p>
如果出现 service mysql start stop 异常的情况,想着查看 sock 文件路径是否正确.
</p>
</div>
</div>
<div id="outline-container-org98b65b2" class="outline-4">
<h4 id="org98b65b2">apt-cacher-ng</h4>
<div class="outline-text-4" id="text-org98b65b2">
<p>
apt-cacher 分为服务端和客户端, 服务端配置:
/etc/apt-cacher-ng/acng.conf
 客户端配置:
</p>
<ol class="org-ol">
<li>vim /etc/apt/apt.conf.d/02proxy
Acquire::<a href="http::proxy">http::proxy</a> "<a href="http://cacheserverlp:3142/">http://cacheserverlp:3142/</a>";</li>
</ol>
<p>
2.或者替换成 :
deb <a href="http://x.x.x.x:3142/web-domain/">http://x.x.x.x:3142/web-domain/</a> version main
</p>
</div>
</div>
</div>

<div id="outline-container-orgcede098" class="outline-3">
<h3 id="orgcede098">2015-05-19</h3>
<div class="outline-text-3" id="text-orgcede098">
</div><div id="outline-container-org14d6add" class="outline-4">
<h4 id="org14d6add">如果出现W: There is no public key available for the following key IDs: 4D270D06F42584E6 类似的情况</h4>
<div class="outline-text-4" id="text-org14d6add">
<p>
解决办法:
apt-get install debian-keyring debian-archive-keyring
apt-key update
</p>
</div>
</div>
<div id="outline-container-org72711b2" class="outline-4">
<h4 id="org72711b2">sudo: unable to resolve host</h4>
<div class="outline-text-4" id="text-org72711b2">
<p>
问题在于安装服务器的时候的主机名被改动
解决办法:
在 hosts 里边把 127.0.0.1 指向当前主机名
</p>
</div>
</div>
<div id="outline-container-org391836c" class="outline-4">
<h4 id="org391836c">设置静态 ip</h4>
<div class="outline-text-4" id="text-org391836c">
<p>
debian: /etc/networks/interfaces
iface eth0 inet static
      address x.x.x.x
      netmask x.x.x.x
      gateway x.x.x.x
centos: /etc/sysconfig/network-scripts/ifcfg-en.xxx
BOOTPROTO=static
ONBOOT=yes
IPADDR=x.x.x.x
GATEWAY=x.x.x.x
NETMASK=x.x.x.x
</p>
</div>
</div>
<div id="outline-container-orgb87aca1" class="outline-4">
<h4 id="orgb87aca1">debian phpize</h4>
<div class="outline-text-4" id="text-orgb87aca1">
<p>
apt-get install php5-dev
</p>
</div>
</div>
</div>

<div id="outline-container-orgda0e1cf" class="outline-3">
<h3 id="orgda0e1cf">2015-05-20</h3>
<div class="outline-text-3" id="text-orgda0e1cf">
</div><div id="outline-container-org1ef3a4a" class="outline-4">
<h4 id="org1ef3a4a">csapp 深入理解计算机系统</h4>
</div>
<div id="outline-container-org9fddfdc" class="outline-4">
<h4 id="org9fddfdc">尾递归优化,计算机用迭代的形式解释递归</h4>
</div>
<div id="outline-container-org7871e14" class="outline-4">
<h4 id="org7871e14">&lt;suffix&gt; invalid DN 21 openldap</h4>
<div class="outline-text-4" id="text-org7871e14">
<p>
需要在配置文件中添加 core cosine inetorgperson nis.schema
slaptest -f slapd.conf -v 生成配置文件
</p>
</div>
</div>
</div>

<div id="outline-container-org372e6a8" class="outline-3">
<h3 id="org372e6a8">2015-05-21</h3>
<div class="outline-text-3" id="text-org372e6a8">
</div><div id="outline-container-orgee04910" class="outline-4">
<h4 id="orgee04910">too many connections failed ssh</h4>
<div class="outline-text-4" id="text-orgee04910">
<p>
just add MaxAuthTries=100 to the sshd_config
</p>
</div>
</div>

<div id="outline-container-org68d0bfc" class="outline-4">
<h4 id="org68d0bfc">debian ldap server</h4>
<div class="outline-text-4" id="text-org68d0bfc">
<p>
ldap 可以通过网络获取账号密码 sudo 权限等
apt-get install python-dev python-pip libmysqlclient-dev libldap2-dev(lber.h)
apt-get install slapd sudo-ldap ldap-utils
</p>

<p>
server 设置过程中可能的错误
/etc/ldap/slapd.d/目录的权限
/var/lib/ldap 目录的权限
装好 ldap-server 的配置之后.
</p>

<p>
sudo cp /usr/share/doc/sudo-ldap/schema.OpenLDAP /etc/ldap/schema/sudo.schema
在/etc/ldap/slapd.conf 中添加 sudo.schema
</p>
</div>


<div id="outline-container-org0ca50cd" class="outline-5">
<h5 id="org0ca50cd">安装 client</h5>
<div class="outline-text-5" id="text-org0ca50cd">
<p>
apt-get install libnss-ldap libpam-ldap sudo-ldap
</p>

<p>
安装 libnss-ldap 的时候设置 ldap 的服务器,和账号密码等
</p>

<p>
需要修改是
/etc/libnss-ldap.conf /etc/libnss-ldap.secret
/etc/pam_ldap.conf /etc/pam_ldap.secret
</p>
</div>
</div>

<div id="outline-container-org5c3c96a" class="outline-5">
<h5 id="org5c3c96a">nsswitch.conf  添加</h5>
<div class="outline-text-5" id="text-org5c3c96a">
<p>
passwd: compat ldap
group: compat ldap
shadow: compat ldap
netgroup: ldap
</p>
</div>
</div>

<div id="outline-container-org8ef47cf" class="outline-5">
<h5 id="org8ef47cf">/etc/pam.d/common-session</h5>
<div class="outline-text-5" id="text-org8ef47cf">
<p>
session optional pam_mkhomedir.so skel=/etc/skel umask=022
</p>
</div>
</div>

<div id="outline-container-org3ccdcf7" class="outline-5">
<h5 id="org3ccdcf7">/etc/pam.d/common-password ( remove 'use_authtok' )</h5>
<div class="outline-text-5" id="text-org3ccdcf7">
<p>
password     [success=1 user_unknown=ignore default=die]     pam_ldap.so try_first_pass
</p>
</div>
</div>


<div id="outline-container-org6195dce" class="outline-5">
<h5 id="org6195dce">sudo 支持</h5>
<div class="outline-text-5" id="text-org6195dce">
<p>
sudo -V 查看 sudo 是否支持 ldap, 需要--with-ldap, 如果支持, 查看 ldap 的配置文件
一般是 /etc/sudo-ldap.conf /etc/ldap.secret
</p>
</div>
</div>

<div id="outline-container-org9c836f3" class="outline-5">
<h5 id="org9c836f3">sudo-ldap.conf, 一般为 ldap.conf连接</h5>
<div class="outline-text-5" id="text-org9c836f3">
<p>
URI ldap://192.168.81.191
BASE dc=jumpserver,dc=org
Sudoers_base ou=Sudoers,dc=jumpserver,dc=org
</p>
</div>
</div>

<div id="outline-container-orgaa82a6f" class="outline-5">
<h5 id="orgaa82a6f">ldap.secret</h5>
<div class="outline-text-5" id="text-orgaa82a6f">
<p>
为密码
</p>
</div>
</div>
</div>


<div id="outline-container-orgd4580b3" class="outline-4">
<h4 id="orgd4580b3">2015-05-25 apache 加密</h4>
<div class="outline-text-4" id="text-orgd4580b3">
<p>
htpasswd -nbs username password
</p>
</div>

<div id="outline-container-org6144b50" class="outline-5">
<h5 id="org6144b50">linux 添加用户默认 shell 设置</h5>
<div class="outline-text-5" id="text-org6144b50">
<p>
/etc/default/useradd 中, 可以设置默认的 shell, 默认的 skel,home 目录等.
</p>
</div>
</div>
</div>

<div id="outline-container-orga3730a7" class="outline-4">
<h4 id="orga3730a7">2015-05-26</h4>
<div class="outline-text-4" id="text-orga3730a7">
</div><div id="outline-container-org7f31c69" class="outline-5">
<h5 id="org7f31c69">haproxy 添加 ip 限制</h5>
<div class="outline-text-5" id="text-org7f31c69">
<p>
默认情况下, haproxy 会转发 请求到 nginx,首先要在 haproxy 上添加配置:
--  option forwardfor
在 nginx 中,被转发的请求的 remote_addr, 会被识别为 haproxy 的地址,一般是内网地址,如果要恢复为原来的真实 ip 地址,需要 realip 模块
编译的时候添加 --with-http_realip_module
 然后可以在 server 中添加配置
 set_real_ip_from x.x.x.x;
 real_ip_header X-Forwarded-For;
这样 remote_addr 就是真实的 ip 了,可以做 allow 和 deny 的限制了.
<a href="http://blog.pengqi.me/2013/04/20/remote-addr-and-x-forwarded-for/">http://blog.pengqi.me/2013/04/20/remote-addr-and-x-forwarded-for/</a>
</p>
</div>
</div>

<div id="outline-container-orgc048fa4" class="outline-5">
<h5 id="orgc048fa4">刷新 dns 缓存</h5>
<div class="outline-text-5" id="text-orgc048fa4">
<p>
windows: ipconfig /flushdns
linux: service nscd restart
mac: type dscacheutil -flushcache
    或者 killall -HUP mDNSResponder
</p>
</div>
</div>

<div id="outline-container-org72e65be" class="outline-5">
<h5 id="org72e65be">inittab</h5>
<div class="outline-text-5" id="text-org72e65be">
<p>
id : runlevel : action : process
</p>

<p>
actions:
respawn
  启动并监视第4项指定的process，若process终止则重启它
wait
  执行第4项指定的process，并等待它执行完毕
once
  执行第4项指定的process
boot
  不论在哪个执行等级，系统启动时都会运行第4项指定的process
bootwait
  不论在哪个执行等级，系统启动时都会运行第4项指定的process，且一直等它执行完备
off
  关闭任何动作，相当于忽略该配置行
ondemand
  进入ondemand执行等级时，执行第4项指定的process
initdefault
  系统启动后进入的执行等级，该行不需要指定process
sysinit
  不论在哪个执行等级，系统会在执行boot 及bootwait之前执行第4项指定的process
powerwait
  当系统的供电不足时执行第4项指定的 process，且一直等它执行完毕
powerokwait
  当系统的供电恢复正常时执行第4项指定的process，且一直等它执行完毕
powerfailnow
  当系统的供电严重不足时执行第4项指定的process
ctrlaltdel
  当用户按下【Ctrl+Alt+Del】时执行的操作
kbrequest
  当用户按下特殊的组合键时执行第4项指定的process，此组合键需在keymaps文件定义
</p>
</div>
</div>
</div>
</div>
</div>

    </div>
</section>


<footer id="footer">
    <br />
</footer>

  </body>
</html>
